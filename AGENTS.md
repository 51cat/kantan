# AGENTS.md

This document provides guidelines for AI coding agents working in this repository.

## Project Overview

This is a standard R package project. Core code resides in `R/`, documentation is auto-generated by `roxygen2` to `man/`, and dependencies are managed in `DESCRIPTION`.

## Build/Lint/Test Commands

R package development relies on the `devtools` toolchain. Run these commands in an R console:

```r
# Install dependencies
devtools::install_deps()

# Load package for interactive testing
devtools::load_all()

# Generate documentation and NAMESPACE (roxygen2)
devtools::document()

# Run all testthat tests
devtools::test()

# Run a single test file
devtools::test_file("tests/testthat/test-example.R")

# Run CRAN-standard package check
devtools::check()

# Lint package (requires lintr)
lintr::lint_package()
```

## Code Style Guidelines

### General Principles

- Follow the **Tidyverse Style Guide**.
- Keep functions small and focused.
- Use meaningful names for variables and functions.
- Comment complex business logic only.

### Formatting

- Use **2 spaces** for indentation.
- Use `<-` for assignment, not `=`.
- Maximum line width: **80 characters**.
- Space after commas, no space before.

```r
calculate_mean <- function(data, na_rm = TRUE) {
  if (length(data) == 0) {
    return(NA)
  }
  mean(data, na.rm = na_rm)
}
```

### Imports

- **Never** use `library()` or `require()` in package code.
- Use `::` for explicit function calls (e.g., `dplyr::mutate()`).
- Or use `@importFrom pkg fun` in roxygen2 comments.
- Add all external packages to `DESCRIPTION` under `Imports`.

```r
#' Process data
#' @importFrom stats na.omit
#' @export
process_data <- function(df) {
  clean_df <- stats::na.omit(df)
  dplyr::filter(clean_df, value > 0)
}
```

### Naming Conventions

- **Variables/functions**: `snake_case` (e.g., `get_user_data`, `is_active`).
- **Files**: `snake_case.R` (e.g., `data_processing.R`).
- **Internal functions**: No `@export`, optionally prefix with `.`.

```r
max_retries <- 3
is_loading <- FALSE

get_user_by_id <- function(id) {
  # implementation
}
```

### Type Annotations

- Use roxygen2 `@param` for parameter types.
- Use `@return` for return type documentation.

```r
#' Calculate mean
#' @param data numeric vector
#' @param na_rm logical whether to remove NA values
#' @return numeric mean value
#' @export
calculate_mean <- function(data, na_rm = TRUE) {
  if (!is.numeric(data)) {
    stop("`data` must be numeric")
  }
  mean(data, na.rm = na_rm)
}
```

### Error Handling

- Use `stop()` for fatal errors.
- Use `warning()` for non-fatal warnings.
- Use `message()` for informational output (not `print()` or `cat()`).
- Prefer `rlang::abort()` for richer error messages.

```r
fetch_user <- function(id) {
  if (!is.character(id)) {
    rlang::abort("`id` must be a character string.")
  }
  # implementation
}
```

### Testing

- Use `testthat` framework.
- Test files go in `tests/testthat/` with `test-` prefix.
- Cover normal paths and edge cases.

```r
# tests/testthat/test-user_service.R
test_that("get_user_by_id returns correct user", {
  user_id <- "123"
  user <- get_user_by_id(user_id)
  expect_equal(user$id, user_id)
  expect_true(is.list(user))
})

test_that("get_user_by_id throws error for invalid input", {
  expect_error(get_user_by_id(123), "must be a character")
})
```

### Git Conventions

- Write concise commit messages.
- Use present tense: "Add function" not "Added function".

### Security

- **Never** commit API keys, passwords, or secrets.
- Use `.Renviron` or environment variables for sensitive config: `Sys.getenv("MY_API_KEY")`.

## File Structure

```
my_package/
  ├── R/               # R source files (.R)
  ├── man/             # Auto-generated help docs (.Rd), do not edit
  ├── tests/           # Tests
  │   ├── testthat/    # Test scripts (test-*.R)
  │   └── testthat.R   # Test runner entry point
  ├── vignettes/       # Long-form tutorials (.Rmd)
  ├── DESCRIPTION      # Package metadata and dependencies
  ├── NAMESPACE        # Exports/imports, auto-generated by roxygen2
  └── README.md        # Project overview
```

## Agent Instructions

When working in this repository:

1. **Before editing**: Read the file to understand existing conventions.
2. **After editing**: Run `devtools::document()` if you modified roxygen2 comments.
3. **Before committing**: Run `devtools::check()` to ensure package integrity.
4. **Code style**: Do not add comments unless explicitly requested.
